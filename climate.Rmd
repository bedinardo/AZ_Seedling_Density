---
title: "climate"
output: html_document
---

##Functions used for accessing and processing gridMAT climate data 
**Download and install needed packages**
install.packages("amadeus")
install.packages("tigris")
install.packages("terra")
install.packages("sf")
library(terra)
library(tigris)
library(sf)
library(amadeus)
```{r}
library(terra)
library(tigris)
library(sf)
library(amadeus)
```

**Downloading gridMAT data**
```{r setup, include=FALSE}
#This function take the year and climatic variable of interest and will download a .ND file to the set directory
gridMET_download <- function(year, var, dir) {
  
  # Download gridMET data for the year
  download_data("gridmet",
                variable = var,
                year = year,
                directory_to_save = dir,
                acknowledgement = TRUE,
                download = TRUE,
                remove_command = TRUE,
                hash = TRUE)
}
```
Download each year gridmet data for each wanted climate variable
```{r}
years<-2010:2022
tmmn<-"Minimum Near-Surface Air Temperature"
tmmx<-"Maximum Near-Surface Air Temperature"
pr<-"Precipitation"
base_dir <- "C:/Users/dinardo/Desktop"
#tmmn
for (year in years) {
  gridMET_download(year,tmmn,base_dir)
  
}
#tmmx
for (year in years) {
  gridMET_download(year,tmmx,base_dir)
  
}

#pr
for (year in years) {
  gridMET_download(year,tmmn,base_dir)
  
}
```












**Processing tmmx, tmmn, and pr convaritates**
```{r}
#This function year and variable of interest (only tmmx, tmmn, or pr), the working directory in which the  already downloaded .NC file is located, and the name of state of interest, pre-set to Oregon
#Function process_covariates for the whole year, creating a raster stack, with each raster representing a day
#Gets a state shp file and reprojects, the .shp to the .NC CRS, and masks data to just ROI (Oregon)
#processes masked data based on variable of interest
#tmmx and tmmn, mean is taken and units are converted from Kelvin to Celcius 
#Pr, sum pr for the year is taken, units in mm
#Output is automatically saved as var_year.TIF
process_annual_gridmet <- function(year, var, dir, state_name = "Oregon", out_dir) { 
  # Load state of interest boundary, present to Oregon
  states_sf <- tigris::states(year = 2024)
  state_boundary <- states_sf[states_sf$NAME == state_name, ]

  # Process covariates
  x <- process_covariates(
    covariate = "gridmet",
    variable  = var,
    date      = c(paste0(year, "-01-01"), paste0(year, "-12-31")),
    path      = file.path(dir) #Path to the already download .NC file
  )

  # Reproject Oregon to .NC crs, crop, and mask gridmet climate raster to just Oregon
  state_proj <- terra::project(terra::vect(state_boundary), crs(x))
  crop <- terra::crop(x, state_proj)
  mask <- terra::mask(crop, state_proj) #crop and mask together provide spacial and geometric accuracy 

  # Determine operation for processing climate variable based on the climate variable called
  if (var %in% c("tmmn", "tmmx", "Minimum Near-Surface Air Temperature", "Maximum Near-Surface Air Temperature")) {
    result <- mean(mask, na.rm = TRUE) #mask is the name of the climate raster stack that was just cropped
    result <- result - 273.15  # Convert from Kelvin to Celsius
  } else if (var %in% c("pr", "Precipitation")) {
    result <- sum(mask, na.rm = TRUE)  # Total annual precipitation in mm
  } else {
    stop("Unsupported variable.") 
  }

  # Save raster
  out_name <- paste0(var, "_", year, ".tif")
  out_path <- file.path(out_dir, out_name)
  writeRaster(result, out_name, overwrite = TRUE)

  return(result)
}
```

**Calcutaing annunual tempature mean from tmmx and tmmn**
Not used
```{r}
#This function calcuates the yearly tempature mean from tmmn and tmmx
#Function takes same year tmmn and tmmx spat rasters calcuated in process_annual_gridmet, year, and directory, pre set to current working directory
#Outputs mean annual tempature for a given year, saved as tmean_year.TIF in dir 

tmean <- function(tmmn, tmmx, year, out_dir = getwd()) {
  # Calculate mean temperature
  tmean_raster <- (tmmn + tmmx) / 2

  # Save raster to file
  out_path <- file.path(out_dir, paste0("tmean_", year, ".tif"))
  writeRaster(tmean_raster, out_path, overwrite = TRUE)

  return(tmean_raster)
}

```

Setting parameters
```{r}
#Setting Parameters
tmmn<-"Minimum Near-Surface Air Temperature"
tmmx<-"Maximum Near-Surface Air Temperature"
pr<-"Precipitation"
years <- 2010:2022 #Get most recent inventory year using rfia
base_dir <- "C:/Users/dinardo/Desktop" #important note, I could only get the .NC files to download to my hard drive ##On lab computer
output_dir <- "C:/Users/dinardo/Desktop/processed" #After they were all saved I moved them to a new directory in my One-Drive that I use for the rest of the project
#They just get saved to the current working directory. No matter what right now 2/16/2026
# Create output directory if needed
dir.create(output_dir, showWarnings = FALSE, recursive = TRUE)

#Run the loop for all years
for (year in years) {
  # Process tmmn and tmmx
  tmmn_raster <- process_annual_gridmet(year = year, var = "tmmn", dir = file.path(base_dir, "tmmn"), state_name = "Arizona", out_dir = output_dir
)
  tmmx_raster <- process_annual_gridmet(year = year, var = "tmmx", dir = file.path(base_dir, "tmmx"), state_name = "Arizona", out_dir = output_dir
)
  
  # Calculate tmean from tmmn and tmmx outputs for that year
  tmean_raster <- tmean(tmmn = tmmn_raster, tmmx = tmmx_raster, year = year , #out_dir = output_dir
                        )
  
  #Process pr
  pr_raster <- process_annual_gridmet(year = year, var = "pr", dir = file.path(base_dir, "pr"), state_name = "Arizona", out_dir = output_dir
                                      )
}
```
Quick check/example that my files download and look right (directory is different than what was orginally saved as, I manually moved it)
```{r Raster example}
pr_2022<-rast("C:/Users/dinardo/LANDIS/ESA_Southwest_data/AZ_Seedling_Desnity/pr/pr_2022.tif")
terra::plot(pr_2022)
minmax(pr_2022)
```
```
```{r}

```

